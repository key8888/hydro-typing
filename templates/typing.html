{% extends "layout/basic.html" %}
{% block content %}
<div class="row">
  <div class="medium-12 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Typing Practice') }}</h1>
      </div>
      <div class="section__body" style="text-align:center; font-size:2rem; font-family:monospace;">
        <div id="word-display"></div>
        <p>スコア: <span id="score">0</span></p>
        <div id="end-screen" style="display:none; margin-top:20px;">
          <h2>タイピング終了！</h2>
          <p>あなたのスコア: <span id="final-score"></span></p>
          <form id="score-form" method="post" action="/typing">
            <input type="hidden" name="score" id="score-input">
            <button type="submit" class="rounded primary button">スコアを保存</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 履歴表示 -->
    <div class="section">
      <div class="section__header">
        <h2 class="section__title">履歴</h2>
      </div>
      <div class="section__body">
        <table class="table">
          <thead>
            <tr><th>日付</th><th>スコア</th></tr>
          </thead>
          <tbody>
            {% for h in history %}
            <tr>
              <td>{{ h.createdAt }}</td>
              <td>{{ h.score }}</td>
            </tr>
            {% else %}
            <tr><td colspan="2">まだ履歴がありません</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const words = {{ words | safe }};
  let currentWordIndex = 0;
  let currentCharIndex = 0;
  let score = 0;
  let isWaitingNext = false;

  const wordDisplay = document.getElementById('word-display');
  const scoreEl = document.getElementById('score');
  const endScreen = document.getElementById('end-screen');
  const finalScore = document.getElementById('final-score');
  const scoreInput = document.getElementById('score-input');

  function renderWord() {
    const word = words[currentWordIndex];
    let html = '';
    for (let i = 0; i < word.length; i++) {
      if (i < currentCharIndex) {
        html += `<span style="color:green">${word[i]}</span>`;
      } else {
        html += `<span style="color:black">${word[i]}</span>`;
      }
    }
    wordDisplay.innerHTML = html;
  }

  function showEndScreen() {
    wordDisplay.style.display = 'none';
    endScreen.style.display = 'block';
    finalScore.textContent = score;
    scoreInput.value = score; // フォームにセット
  }

  function nextWord() {
    currentWordIndex++;
    currentCharIndex = 0;
    isWaitingNext = false;
    if (currentWordIndex >= words.length) {
      showEndScreen();
    } else {
      renderWord();
    }
  }

  document.addEventListener('keydown', (e) => {
    if (isWaitingNext) return;
    const word = words[currentWordIndex];
    const expected = word[currentCharIndex];
    if (!expected) return;
    if (e.key === expected) {
      currentCharIndex++;
      score++;
      scoreEl.textContent = score;
      renderWord();
      if (currentCharIndex === word.length) {
        isWaitingNext = true;
        setTimeout(nextWord, 1000);
      }
    } else {
      // ミス表示
      let html = '';
      for (let i = 0; i < word.length; i++) {
        if (i < currentCharIndex) {
          html += `<span style="color:green">${word[i]}</span>`;
        } else if (i === currentCharIndex) {
          html += `<span style="color:red">${word[i]}</span>`;
        } else {
          html += `<span style="color:black">${word[i]}</span>`;
        }
      }
      wordDisplay.innerHTML = html;
    }
  });

  renderWord();
</script>
{% endblock %}
